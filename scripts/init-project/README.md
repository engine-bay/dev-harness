# Initialising a new project

## About

This script will help initialize a new project based on the [EngineBay](https://github.com/engine-bay) project structure and architecture.

## Benefits

This script will generate a new dotnet API solution with the following:

- Ready to run in VS Code and Docker
- Modular design
- Entity framework migrations with multiple database providers
- Identity
- Authorisation
- Auditing
- CORS
- Logging
- Rate Limiting
- Data Encryption
- Documentation Portal using MK Docs

## How it works

The script will

1. Prepare the working directory by deleting any files generated by a previous run of the script and pulling the EngineBay git repo if it does not exist.
2. Copy all files from EngineBay into the new folder structure as well as replacing the manually edited files from above
3. Rename EngineBay to the configured project name, including files, folders and file contents. Rename DemoApi to Api and remove package references and nuget properties from the project files
4. Create a new solution and add all the projects.

## Getting started

### Before running the script

Before you can run this script we need to set up the working directory. There are some files that will not be changed by the script, we need to edit these files manually. Instead of making these changes every time we run the script, we will edit and store the modified files. These modified files will be copied in by the script, this allows us to rerun the script multiple times. Store these files in the same directory as the script.

---

.env

The settings file will be taken from the demo-api folder, copy this file and change settings accordingly. For reference these settings were changed previously.

```

ASPNETCORE_URLS=http://*:5050
DATABASE_SEED_DATA_PATH=./usr/local/sbin/seed-data
AUTHENTICATION_AUDIENCE=http://localhost:5050
AUTHENTICATION_ISSUER=http://localhost:5050

```

---

[project-name].code-workspace

Create a VS Code workspace file for the new solution.

```json
{
  "folders": [
    {
      "path": "."
    }
  ]
}
```

---

DockerFile

The docker file in EngineBay does not install dependencies like Python and PIP since it is using pre built nuget packages in the main project. The new project will need to install these dependencies.

```dockerfile
    FROM mcr.microsoft.com/dotnet/sdk:8.0-alpine AS base

    ARG VERSION=0.0.0

    WORKDIR /tmp/build

    ENV PYTHONUNBUFFERED=1
    RUN apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
    RUN python3 -m ensurepip
    RUN pip3 install --no-cache --upgrade pip setuptools
    RUN pip3 install mkdocs

    # copy csproj and restore as distinct layers
    COPY ./Challenges.Api/Challenges.Api.csproj ./Challenges.Api/Challenges.Api.csproj
    RUN dotnet restore ./Challenges.Api/Challenges.Api.csproj

    # copy everything else and build
    COPY . .

    WORKDIR /tmp/build/Challenges.DocumentationPortal/DocumentationPortal
    RUN pip3 install -r requirements.txt
    RUN mkdocs build --strict

    WORKDIR /tmp/build
    RUN dotnet publish ./Challenges.Api/Challenges.Api.csproj --nologo --runtime linux-musl-x64 --self-contained --configuration Release -o /tmp/build/out /p:Version=$VERSION

    # build runtime image
    FROM mcr.microsoft.com/dotnet/runtime-deps:8.0-alpine
    RUN apk add icu-libs
    COPY --from=base /tmp/build/out /usr/local/sbin

    EXPOSE 5050
    ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
    RUN mkdir /seed-data
    ENTRYPOINT ["Challenges.Api"]
```

---

ModuleRegistration.cs

The Documentation Portal is not included in EngineBay.DemoApi. Add this by editing the existing ModuleRegistration file.

```cs
    # code omitted
    using EngineBay.DemoModule;
    using EngineBay.DocumentationPortal;
    using EngineBay.Logging;
    # code omitted

    new CorsModule(),
    new DocumentationPortalModule(),
    new AuthenticationModule(),
    # code omitted
```

### Configuring the script

| Variable                    | Description                                               |
| --------------------------- | --------------------------------------------------------- |
| PROJECT_NAME                | The name of the new Project. Capitalise the first letter. |
| MODULE_CORE                 | Folder and Project name for EngineBay.Core                |
| MODULE_PERSISTENCE          | Folder and Project name for EngineBay.Persistence         |
| MODULE_DATA_PROTECTION      | Folder and Project name for EngineBay.DataProtection      |
| MODULE_API_DOCUMENTATION=   | Folder and Project name for EngineBay.ApiDocumentation    |
| MODULE_AUDITING             | Folder and Project name for EngineBay.Auditing            |
| MODULE_AUTHENTICATION       | Folder and Project name for EngineBay.Authentication      |
| MODULE_CORS                 | Folder and Project name for EngineBay.Cors                |
| MODULE_DATABASE_MANAGEMENT  | Folder and Project name for EngineBay.DatabaseManagement  |
| MODULE_DOCUMENTATION_PORTAL | Folder and Project name for EngineBay.DocumentationPortal |
| MODULE_LOGGING              | Folder and Project name for EngineBay.Logging             |
| MODULE_RATE_LIMITING        | Folder and Project name for EngineBay.RateLimiting        |
| MODULE_DEMO_MODULE          | Folder and Project name for EngineBay.DemoModule          |
| MODULE_DEMO_API             | Folder and Project name for EngineBay.DemoApi             |
| MODULES                     | Array of all projects to process                          |

### Running the script

Execute the script

```bash
./init-project.sh.sh
```

### Test the generated project

```bash
dotnet build
dotnet test --no-build
```

### Run the application in Docker

```bash
docker build -t challenges:latest .
docker run --env-file ./.env -p 5050:5050 --name challenges challenges:latest
```

Authenticate using the admin/admin user

## Useful Links

[EngineBay](https://github.com/engine-bay)
